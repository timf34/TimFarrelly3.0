---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import MobileNav from '../components/MobileNav.astro';
import ImageModal from '../components/ImageModal.astro';
import picsData from '../data/pics-manifest.json';

// Group posts by year
const postsByYear: Record<number, typeof picsData> = {};
for (const post of picsData) {
  if (!postsByYear[post.year]) {
    postsByYear[post.year] = [];
  }
  postsByYear[post.year].push(post);
}

// Sort years descending
const years = Object.keys(postsByYear).map(Number).sort((a, b) => b - a);

// Sort posts within each year by month descending
for (const year of years) {
  postsByYear[year].sort((a, b) => b.month - a.month);
}

// Filter out video files for display (only show images)
function getImages(images: string[]) {
  return images.filter(img => !img.endsWith('.mp4'));
}
---

<Layout title="Pics:) | Tim Farrelly">

  <Header />

  <!-- Mobile Navigation -->
  <MobileNav currentPage="pics" />

  <!-- Main Content -->
  <main class="pics-container">

    <!-- Menu -->
    <nav class="col-menu">
      <ul>
        <li><a href="/">About</a></li>
        <li><a href="/lists">Lists</a></li>
        <li><a href="/writing">Writing</a></li>
        <li><a href="/art">Art Gallery</a></li>
        <li><strong>Pics:)</strong></li>
      </ul>
    </nav>

    <!-- Pics Content -->
    <div class="pics-content">
      <p class="intro">
          I started doing monthly photo dumps on <a href="https://www.instagram.com/tim_farrelly34/" target="_blank" rel="noopener noreferrer">Instagram</a> a while back -- just a collection of pics from each month, 
          sometimes with a separate post if I'd seen a bunch of art. People seem to really like them, but 
          honestly I think I get the most out of it myself. There's something really special about being able to scroll 
          back and see exactly what August 2023 looked like, even if it's just a cherry-picked subsection of reality. 
          It's become one of my favorite little practices, and I'd really encourage more people to try it -- your 
          future self will thank you for the visual time capsule! 
      </p>

      {years.map(year => (
        <section class="year-section">
          <h2>{year}</h2>

          {postsByYear[year].map(post => (
            <div class="month-post" data-post-id={post.id}>
              <h3><b>{post.title}</b></h3>

              <!-- Desktop Grid -->
              <div class="image-grid">
                {getImages(post.images).map((img, idx) => (
                  <button class="image-btn" data-src={`/pics/${img}`} data-index={idx}>
                    <img src={`/pics/${img}`} alt={`${post.title} - Image ${idx + 1}`} loading="lazy" />
                  </button>
                ))}
              </div>

              <!-- Mobile Carousel -->
              <div class="image-carousel">
                <div class="carousel-track">
                  {getImages(post.images).map((img, idx) => (
                    <button class="carousel-slide" data-src={`/pics/${img}`} data-index={idx}>
                      <img src={`/pics/${img}`} alt={`${post.title} - Image ${idx + 1}`} loading="lazy" />
                    </button>
                  ))}
                </div>
              </div>
            </div>
          ))}
        </section>
      ))}
    </div>
  </main>

  <ImageModal />

  <script is:inline>
    // Click handlers for pics page images â€” grouped per month post
    document.querySelectorAll('.month-post').forEach(function (post) {
      var gridButtons = post.querySelectorAll('.image-btn');
      var images = Array.from(gridButtons).map(function (btn) { return btn.getAttribute('data-src') || ''; });

      gridButtons.forEach(function (btn, idx) {
        btn.addEventListener('click', function () { window.openImageModal(images, idx); });
      });

      var carouselButtons = post.querySelectorAll('.carousel-slide');
      carouselButtons.forEach(function (btn, idx) {
        btn.addEventListener('click', function () { window.openImageModal(images, idx); });
      });
    });
  </script>
</Layout>

<style>
  /* Main Layout */
  .pics-container {
    display: grid;
    grid-template-columns: 10% 1fr;
    padding-bottom: 4rem;
  }

  /* Menu */
  .col-menu {
    grid-column: 1;
    display: flex;
    justify-content: center;
  }

  .col-menu ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .col-menu li {
    margin-bottom: 0.5rem;
  }

  .col-menu a {
    text-decoration: none;
  }

  .col-menu a:hover {
    text-decoration: underline;
  }

  /* Pics Content */
  .pics-content {
    grid-column: 2;
    padding-right: 2rem;
    max-width: 1200px;
  }

  .intro {
    margin: 0 0 2rem;
    color: rgba(0, 0, 0, 0.9);
  }

  .year-section {
    margin-bottom: 3rem;
  }

  .year-section h2 {
    font-size: 2rem;
    margin: 0 0 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid rgba(14, 32, 47, 0.1);
  }

  .month-post {
    margin-bottom: 2.5rem;
  }

  .month-post h3 {
    font-size: 1.25rem;
    margin: 0 0 1rem;
    font-weight: 500;
    font-style: italic;
  }

  /* Desktop Grid */
  .image-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 0.75rem;
  }

  .image-btn {
    padding: 0;
    border: none;
    background: none;
    cursor: pointer;
    overflow: hidden;
    aspect-ratio: 1;
    border-radius: 4px;
  }

  .image-btn img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.2s ease;
  }

  .image-btn:hover img {
    transform: scale(1.05);
  }

  /* Mobile Carousel (hidden on desktop) */
  .image-carousel {
    display: none;
  }

  /* Mobile Styles */
  @media (max-width: 900px) {
    .pics-container {
      display: block;
      padding: 0 1.5rem 3rem;
    }

    .col-menu {
      display: none;
    }

    .pics-content {
      padding-right: 0;
    }

    /* Hide grid on mobile */
    .image-grid {
      display: none;
    }

    /* Show carousel on mobile */
    .image-carousel {
      display: block;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .image-carousel::-webkit-scrollbar {
      display: none;
    }

    .carousel-track {
      display: flex;
      gap: 0.75rem;
    }

    .carousel-slide {
      flex: 0 0 auto;
      width: 75vw;
      max-width: 300px;
      aspect-ratio: 1;
      scroll-snap-align: start;
      padding: 0;
      border: none;
      background: none;
      cursor: pointer;
      border-radius: 4px;
      overflow: hidden;
    }

    .carousel-slide img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

  }
</style>
