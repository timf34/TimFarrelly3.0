---
// Sorolla Graphic - hidden surprise at the bottom of the page
---

<div class="sorolla-container">
  <picture>
    <source media="(max-width: 900px)" srcset="/sorolla.jpg" />
    <img id="sorolla-image" src="/sorolla_cropped.jpg" alt="" class="sorolla-img" />
  </picture>
  <canvas id="sorolla-canvas"></canvas>
  <div class="sorolla-quote">
    <span class="quote-backdrop"></span>
    <span class="quote-text">There are cathedrals everywhere
For those with the eyes to see</span>
  </div>
</div>

<script>
  const img = document.getElementById('sorolla-image') as HTMLImageElement;
  const canvas = document.getElementById('sorolla-canvas') as HTMLCanvasElement;
  const ctx = canvas.getContext('2d');
  const quote = document.querySelector('.sorolla-quote') as HTMLElement;

  const CONFIG = {
    lineThickness: 0.12,
    circleThickness: 0.12,
    animationDuration: 200,
  };

  let animationProgress = 0;
  let hasStartedAnimating = false;
  let animationStartTime = 0;

  function easeOutCubic(t: number): number {
    return 1 - Math.pow(1 - t, 3);
  }

  function draw(progress: number) {
    if (!ctx || !img) return;

    const w = img.offsetWidth;
    const h = img.offsetHeight;
    const dpr = window.devicePixelRatio || 1;

    canvas.width = w * dpr;
    canvas.height = h * dpr;
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
    ctx.scale(dpr, dpr);

    ctx.strokeStyle = 'white';
    ctx.lineCap = 'round';

    const halfHeight = h / 2;
    const centerX = w / 2;
    const leftX = centerX - halfHeight;
    const rightX = centerX + halfHeight;
    const circleRadius = halfHeight;

    const lines = [
      { x1: leftX, y1: 0, x2: leftX, y2: h },
      { x1: rightX, y1: 0, x2: rightX, y2: h },
      { x1: centerX, y1: 0, x2: centerX, y2: h },
      { x1: leftX, y1: 0, x2: rightX, y2: h },
      { x1: rightX, y1: 0, x2: leftX, y2: h },
    ];

    const circles = [
      { x: centerX, y: h / 2, radius: circleRadius },
      { x: leftX, y: 4 * h / 5, radius: h / 5 },
      { x: 13 * w / 32, y: 11 * h / 12, radius: h / 12 },
    ];

    // Draw lines with progress
    ctx.lineWidth = (CONFIG.lineThickness / 100) * w;
    lines.forEach((line, i) => {
      const lineDelay = i * 0.1;
      const lineProgress = Math.max(0, Math.min(1, (progress - lineDelay) / 0.5));
      
      if (lineProgress > 0) {
        const easedProgress = easeOutCubic(lineProgress);
        const currentX = line.x1 + (line.x2 - line.x1) * easedProgress;
        const currentY = line.y1 + (line.y2 - line.y1) * easedProgress;

        ctx.beginPath();
        ctx.moveTo(line.x1, line.y1);
        ctx.lineTo(currentX, currentY);
        ctx.stroke();
      }
    });

    // Draw circles with progress (start after lines)
    ctx.lineWidth = (CONFIG.circleThickness / 100) * w;
    circles.forEach((circle, i) => {
      const circleDelay = 0.5 + i * 0.1;
      const circleProgress = Math.max(0, Math.min(1, (progress - circleDelay) / 0.4));
      
      if (circleProgress > 0) {
        const easedProgress = easeOutCubic(circleProgress);
        const endAngle = Math.PI * 2 * easedProgress;

        ctx.beginPath();
        ctx.arc(circle.x, circle.y, circle.radius, -Math.PI / 2, -Math.PI / 2 + endAngle);
        ctx.stroke();
      }
    });

    // Position and fade in quote
    if (quote) {
      const fontSize = Math.max(16, Math.min(w, h) * 0.04);
      const padding = w * 0.03;
      quote.style.fontSize = fontSize + 'px';
      quote.style.right = padding + 'px';
      quote.style.bottom = padding + 'px';
      quote.style.left = 'auto';
      quote.style.top = 'auto';
      
      const quoteProgress = Math.max(0, Math.min(1, (progress - 0.8) / 0.2));
      quote.style.opacity = String(quoteProgress);
    }
  }

  function animate(timestamp: number) {
    if (!animationStartTime) animationStartTime = timestamp;
    
    const elapsed = timestamp - animationStartTime;
    animationProgress = Math.min(1, elapsed / CONFIG.animationDuration);
    
    draw(animationProgress);
    
    if (animationProgress < 1) {
      requestAnimationFrame(animate);
    }
  }

  function checkVisibility() {
    if (hasStartedAnimating) return;
    
    const rect = canvas.getBoundingClientRect();
    const windowHeight = window.innerHeight;
    
    if (rect.top < windowHeight * 0.7) {
      hasStartedAnimating = true;
      requestAnimationFrame(animate);
    }
  }

  function init() {
    draw(0);
    
    window.addEventListener('scroll', checkVisibility, { passive: true });
    
    window.addEventListener('resize', () => {
      draw(animationProgress);
    });
    
    checkVisibility();
  }

  img.onload = init;
  if (img.complete) init();
</script>

<style>
  .sorolla-container {
    width: 100%;
    position: relative;
    margin-top: 8rem;
  }

  .sorolla-container picture {
    display: block;
    width: 100%;
  }

  .sorolla-img {
    width: 100%;
    height: auto;
    display: block;
  }

  #sorolla-canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
  }

  .sorolla-quote {
    position: absolute;
    pointer-events: none;
    opacity: 0;
  }

  .quote-backdrop {
    position: absolute;
    inset: -0.75em -1em;
    background: radial-gradient(
          ellipse at center,
        rgba(0, 0, 0, 0.1) 0%,
        rgba(0, 0, 0, 0.05) 75%,
        rgba(0, 0, 0, 0.0) 100%
    );
    }

  .quote-text {
    position: relative;
    color: white;
    font-family: "EB Garamond", serif;
    font-weight: 600;
    font-style: italic;
    line-height: 1.6;
    white-space: pre-line;
    letter-spacing: 0.05em;
    text-align: right;
    display: block;
  }
</style>